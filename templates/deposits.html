{% extends 'base.html' %}

{% block title %}Deposits - Tesla Investment Platform{% endblock %}

{% block content %}
<div class="space-y-8 px-4 md:px-0">
    <h1 class="text-4xl md:text-5xl font-bold text-white">Deposit Funds</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Deposit Form -->
        <div class="bg-gray-900 rounded-lg shadow-2xl p-6 border border-gray-800">
            <h2 class="text-2xl font-bold text-white mb-6">Submit Deposit</h2>
            
            {% if success %}
            <div class="bg-green-900 border border-green-800 text-green-200 px-4 py-3 rounded mb-4">
                ✅ {{ success }}
            </div>
            {% endif %}
            
            {% if error %}
            <div class="bg-red-900 border border-red-800 text-red-200 px-4 py-3 rounded mb-4">
                ❌ {{ error }}
            </div>
            {% endif %}

            <form id="deposit-form" method="post" action="/deposits/" class="space-y-4">
                {% csrf_token %}
                
                <div>
                    <label for="cryptocurrency" class="block text-sm font-medium text-gray-300 mb-2">Select Cryptocurrency</label>
                    <select id="cryptocurrency" name="cryptocurrency" required onchange="updateWallet()" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-white transition">
                        <option value="">Choose a cryptocurrency...</option>
                        {% for wallet in wallets %}
                        <option value="{{ wallet.cryptocurrency }}" data-address="{{ wallet.wallet_address }}">
                            {{ wallet.get_cryptocurrency_display }} ({{ wallet.cryptocurrency }})
                        </option>
                        {% endfor %}
                    </select>
                    <p class="text-sm text-gray-400 mt-1">Select the cryptocurrency you sent</p>
                </div>

                <div id="selected-wallet" class="mt-4 hidden" aria-live="polite">
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                        <h4 class="font-bold text-white mb-2">Receiving Address</h4>
                        <p id="selected-wallet-address" class="text-gray-400 break-all text-sm mb-3 font-mono">Choose a cryptocurrency to reveal the receiving address.</p>
                        <button type="button" id="copy-selected-wallet" class="hidden bg-white hover:bg-gray-200 text-black px-3 py-1 rounded text-sm transition font-semibold" onclick="copyAddress()">Copy Address</button>
                    </div>
                </div>

                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-300 mb-2">Amount</label>
                    <input type="number" id="amount" name="amount" step="0.00000001" min="0" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-white transition placeholder-gray-500">
                </div>

                <div>
                    <label for="proof_type" class="block text-sm font-medium text-gray-300 mb-2">Proof Type</label>
                    <select id="proof_type" name="proof_type" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-white transition">
                        <option value="">Select proof type...</option>
                        <option value="transaction_id">Transaction ID</option>
                        <option value="screenshot">Screenshot</option>
                        <option value="note">Note</option>
                    </select>
                </div>

                <div id="proof-content-group">
                    <label for="proof_content" class="block text-sm font-medium text-gray-300 mb-2">Proof Content</label>
                    <textarea id="proof_content" name="proof_content" rows="3" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 text-white rounded-lg focus:ring-2 focus:ring-white transition placeholder-gray-500"></textarea>
                </div>

                <div id="proof-image-group" class="hidden">
                    <label for="proof_image" class="block text-sm font-medium text-gray-300 mb-2">Upload Screenshot</label>
                    <input type="file" id="proof_image" name="proof_image" accept="image/*" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 text-gray-400 rounded-lg">
                </div>

                <button type="submit" class="w-full bg-white hover:bg-gray-200 text-black font-bold py-3 px-4 rounded-lg transition">
                    Submit Deposit
                </button>
            </form>
        </div>
        <!-- Recent Deposits -->
        <div class="bg-gray-900 rounded-lg shadow-2xl p-6 border border-gray-800">
            <h2 class="text-2xl font-bold text-white mb-6">Your Deposits</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="border-b border-gray-700">
                        <tr class="text-gray-300">
                            <th class="text-left py-2">Date</th>
                            <th class="text-left py-2">Cryptocurrency</th>
                            <th class="text-right py-2">Amount</th>
                            <th class="text-center py-2">Status</th>
                        </tr>
                    </thead>
                    <tbody id="deposits-table" class="divide-y divide-gray-700">
                        {% if deposits %}
                            {% for deposit in deposits %}
                            <tr class="hover:bg-gray-800 transition">
                                <td class="py-2 text-gray-400">{{ deposit.created_at|date:"M d, Y H:i" }}</td>
                                <td class="py-2 text-gray-400">{{ deposit.cryptocurrency }}</td>
                                <td class="py-2 text-right font-mono text-gray-400">{{ deposit.amount|floatformat:8 }}</td>
                                <td class="py-2 text-center">
                                    <span class="text-xs font-bold px-2 py-1 rounded-full {% if deposit.status == 'approved' %}bg-green-900 text-green-400{% elif deposit.status == 'pending' %}bg-yellow-900 text-yellow-400{% elif deposit.status == 'rejected' %}bg-red-900 text-red-400{% else %}bg-gray-700 text-gray-300{% endif %}">
                                        {{ deposit.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="4" class="py-4 text-center text-gray-400">No deposits yet</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function updateWallet() {
    const select = document.getElementById('cryptocurrency');
    const option = select.options[select.selectedIndex];
    const address = option.getAttribute('data-address');
    const walletDiv = document.getElementById('selected-wallet');
    const addressEl = document.getElementById('selected-wallet-address');
    const copyBtn = document.getElementById('copy-selected-wallet');
    
    if (address) {
        walletDiv.classList.remove('hidden');
        addressEl.textContent = address;
        copyBtn.classList.remove('hidden');
    } else {
        walletDiv.classList.add('hidden');
        addressEl.textContent = 'Choose a cryptocurrency to reveal the receiving address.';
        copyBtn.classList.add('hidden');
    }
}

function copyAddress() {
    const address = document.getElementById('selected-wallet-address').textContent;
    navigator.clipboard.writeText(address).then(() => {
        alert('Address copied to clipboard!');
    });
}
</script>
{% endblock %}
